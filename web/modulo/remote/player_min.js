svGlobal.Player=function(){function C(){f=m=k=0;h=c=null;l=false;a.state=a.CLOSED;f=m=k=0;h=c=null;l=false}function F(){if(p){try{p.abort()}catch(g){}p=null}if(a.state==a.PLAYING){a.state=a.CLOSED;w=true;if(h){clearTimeout(h);h=null}a.close()}else{C();w=false}}function x(a,b){return(a[b]&255)<<8|a[b+1]&255}function t(a,b){return(a[b]&255)<<24|(a[b+1]&255)<<16|(a[b+2]&255)<<8|a[b+3]&255}function G(){m+=u;a.onprogress(m,k)}function H(g,b){if(a.state!=a.PLAYING){f-=8;return}var c=g.target.result;var d=
function(){if(v){clearInterval(v);v=0}if(a.onprogress)a.onprogress(b,k);m=b;if(a.state==a.PLAYING){if(y)a.onmessage({"data":c.slice(2)});else a.onmessage({"data":c});f+=c.byteLength;q(8,z)}else f-=8};if(a.state==a.PLAYING){var e=l?0:b-m;if(e<10)e=0;if(l)if(n>0)if(b>=n){a.onmessage({"data":'3D{"type":2,"status":1}'});l=false;n=0}if(e>0)h=setTimeout(d,e);else d();if(e>u*3)v=setInterval(G,u)}}function z(g){if(a.state!=a.PLAYING)return;var b=new Int8Array(g.target.result);if(b.length!=8){if(a.onprogress)a.onprogress(k,
k);a.close();return}var c=t(b,0);var d=t(b,4);if(d<0){console.error("Duration:"+d);d=0}var e=function(a){D=d;H(a,d)};if(a.state==a.PLAYING){f+=8;q(c,e)}}function I(g,b,f){var d=svManager.getInstance();if(d){d.close();d=null}c=new svGlobal.Rdp(a,g,b,f);c.displayMsg=false;var e=new svGlobal.LocalInterface;e.setReadOnly(true);e.hideWhenClose=false;c.addSurface(e);c.run()}function J(g,b,f){var d=svManager.getInstance();if(d){d.close();d=null}c=new svGlobal.Vnc(a,g,b,f);c.displayMsg=false;var e=new svGlobal.LocalInterface;
e.setReadOnly(true);e.hideWhenClose=false;c.addSurface(e);c.run()}function K(g,b,f){var d=svManager.getInstance();if(d){d.close();d=null}c=new svGlobal.SSH(a,g,b,f);c.displayMsg=false;var e=new svGlobal.LocalInterface;e.setReadOnly(true);e.hideWhenClose=false;c.addSurface(e);c.run()}function L(g,b,f){var d=svManager.getInstance();if(d){d.close();d=null}c=new svGlobal.TELNET(a,g,b,f);c.displayMsg=false;var e=new svGlobal.LocalInterface;e.setReadOnly(true);e.hideWhenClose=false;c.addSurface(e);c.run()}
function E(g){var b=new Int8Array(g.target.result);r=String.fromCharCode(b[0],b[1],b[2],b[3]);var l=x(b,4);var d=x(b,6);var e=x(b,8);var h=b[10]&255;m=0;k=t(b,19)<<32|t(b,23);console.log("total time:"+k+" type:"+r+" width:"+d+" height:"+e+" color:"+h);if(!d||!e){hi5.notifications.notify("Invalid resolution, width:"+d+" height:"+e);return}u=k/100|0;if(r=="RDPV")I(d,e,h);else if(r=="VNCV")J(d,e,h);else if(r=="SSHV"){y=true;K(d,e,h)}else if(r=="TELV"){y=true;L(d,e,h)}else{hi5.notifications.notify("Invalid format!");
return}if(a.onopen)a.onopen();if(a.onopened)a.onopened({"width":d,"height":e,"color":h,"version":l,"length":k,"size":A.size});f=64;if(n>0)c.getDesktop().pause(true);q(8,z)}function q(g,b){if(a.state!=a.PLAYING)if(g==8)return;else f-=8;var c=null;if(B)c=A.slice(f,f+g);else{f=0;B=true;q(64,E);return}p=new FileReader;p.onload=b;p.readAsArrayBuffer(c)}var a=this;var f=0;var m=0;var k=0;var u=0;var v=0;var A=null;var h=null;var c=null;var p=null;var l=false;var w=false;var n=0;var r="";var y=false;this.PLAYING=
0;this.PAUSED=1;this.CLOSED=3;var D=0;this.state=this.CLOSED;var B=true;this.close=function(){console.log("Player closed");try{if(a.onclose){a.onclose({"code":0,"reason":""});a.onclose=null}if(c){c.close();c=null}}finally{C()}};this.setSource=function(a){F();if(!a){alert(__svi18n.player.noinput);return}if(!("slice"in a)){a.slice=a.webkitSlice||a.mozSlice;if(!("slice"in a)){alert(__svi18n.file.slice);return}}A=a};this.send=function(){};this.play=function(){a.state=a.PLAYING;if(f==0){var c=function(){f=
0;q(64,E)};if(w)setTimeout(c,888);else c()}else q(8,z)};this.scan=function(a){l=a};this.pause=function(){a.state=a.PAUSED};this.seek=function(a){if(c){l=true;c.getDesktop().pause(true);n=parseInt(k*a/100);console.log("call for player"+a+"==="+n);if(n<D)B=false}}};svGlobal.RdpPlayer=svGlobal.Player;
